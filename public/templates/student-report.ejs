<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
        <%- include('../../common-modules/templates/custom-font', { font }); %>
        <style>
            /* html {
                zoom: 0.75;
            } */
            body {
                direction: rtl;
                font-family: CustomFont, 'Roboto', sans-serif;
                font-size: 12px;
                min-height: 35cm;
            }
            .container {
                width: calc(100% - 100px);
                max-width: 1200px;
                margin: auto;
                text-align: center;
                padding-top: 24px;
            }
            .header-wrapper {
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-justify-content: space-around;
                -ms-justify-content: space-around;
                justify-content: space-around;
            }
            h3 {
                margin: 0;
            }
            .value {
                font-weight: normal;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                margin-top: .5em;
            }
            table, th, td {
                border: 1px solid black;
                padding: 4px;
            }
            th {
                /* background-color: #727fc9; */
                border: 3px solid black;
                /* font-size: 1.25rem; */
                /* color: white; */
            }
            .full-cell {
                min-width: 75px;
                max-width: 100px;
            }
            .empty_cell {
                min-width: 60px;
            }
            .end-image {
                position: fixed;
                bottom: 0;
                right: 0;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <%- include('header', { title, img }); %>
        <div class="container">
            <div class="header-wrapper">
                <% if (student) { %>
                    <h3>תלמידה: 
                        <span class="value"><%= student.name %></span>
                    </h3>
                <% } %>
                <% if (klass) { %>
                    <h3>כיתה: 
                        <span class="value"><%= klass.name %></span>
                    </h3>
                <% } %>
            </div>

            <table>
            <% if (reports.length > 0) { %>
                <tr>
                    <th>מקצוע</th>
                    <th>שם המורה</th>
                    <% if (reportParams.grades) { %>
                        <th>ציון</th>
                    <% } %>
                    <th>אחוז נוכחות</th>
                </tr>
                <% reports.forEach((report, index) => { %>
                    <% if (!reportParams.forceGrades || report.grade) { %>
                        <tr>
                            <td class="full-cell"><%= report.lesson_name %></td>
                            <td class="full-cell"><%= report.teacher_name %></td>

                            <% var att_percents = Math.round(((report.lessons - report.abs_count) / report.lessons) * 100) %> 
                            
                            <% if (reportParams.grades) { %>
                                <td class="full-cell">
                                <% if (report.grade) { %>
                                    <% var grade_effect = att_grade_effect?.find(item => item.percents <= att_percents)?.effect ?? 0 %> 
                                    <% var affected_grade = Math.min(100, report.grade + grade_effect) %> 
                                    <% var matching_grade_name = grade_names?.find(item => item.key <= affected_grade)?.name %> 

                                    <% if (matching_grade_name) { %> 
                                        <%= matching_grade_name %>
                                    <% } else { %> 
                                        <%= affected_grade %>%
                                    <% } %> 
                                <% } else { %>
                                    &nbsp;
                                <% } %>
                                </td>
                            <% } %>
                            <td class="full-cell"><%= att_percents %>%</td>
                            </tr>
                    <% } %>
                <% }) %>
                <% if (!reportParams.hideAbsTotal) { %>
                    <tr>
                        <th>אחוז נוכחות כללי</th>
                        <th>&nbsp;</th>
                        <% if (reportParams.grades) { %>
                            <th>&nbsp;</th>
                        <% } %>

                        <% var total_lesson_count = reports.reduce((a, b) => a + b.lessons, 0) %> 
                        <% var total_abs_count = reports.reduce((a, b) => a + b.abs_count, 0) %> 
                        <% var total_att_count = total_lesson_count - total_abs_count %> 

                        <th>
                            <%= 
                                Math.round(((total_att_count) / total_lesson_count) * 100)
                            %>%
                        </th>
                    </tr>
                    <tr>
                        <th>נוכחות בקיזוז חיסורים מאושרים</th>
                        <th>&nbsp;</th>
                        <% if (reportParams.grades) { %>
                            <th>&nbsp;</th>
                        <% } %>
                        <th>
                            <%= 
                                Math.round(((total_att_count + (approved_abs_count?.total || 0)) / total_lesson_count) * 100)
                            %>%
                        </th>
                    </tr>
                <% } %>
            <% } %>
            </table>

            <% if (reportParams.personalNote) { %>
                <h4>
                    <%= reportParams.personalNote %>
                </h4>
            <% } %>
        </div>
        <div class="end-image">
            <%- include('image', { img: footerImage }); %>
        </div>
    </body>
</html>
